<div class="well">
  <center><strong><%=@date.to_date.year%>년 <%=@date.to_date.month%>월 <%=@date.to_date.day%>일의 <%=@class.building_name%> '<%=@class.room_number%>호'</strong>에 대한 예약현황입니다.</center>
  <br><center><a href="/book/booking/<%=@class.id%>&date=<%=@date%>" class="btn btn-warning">예약하기</a></center>
</div>


<div class="containter"> 
<div class="row">
<div class="col-md-12 col-md-offset-1">
  <div class="well" >한눈에 보는 예약(시간순)
    <div class="progress">
      <% @class.reservations.where(date: @date).order(:start_time).each do |c| %>
       <%@reservation_width=(c.finish_time-c.start_time)/450%>
       <%@progress_color=["progress-bar progress-bar-success","progress-bar progress-bar-info","progress-bar progress-bar-warning","progress-bar progress-bar-danger"]%>
        
          <div id="reservation_progress" class="<%=@progress_color[c.id%4]%>" role="progressbar" aria-valuenow="<%=@reservation_width%>" aria-valuemin="0" aria-valuemax="100" style="width: <%=@reservation_width%>%">
          <!--<span class="badge">%=c.start_time.to_time.hour%> : %=c.start_time.to_time.min%></span>-->
          <%=User.find(c.user).student_name %> <a data-toggle="modal" href="#show<%=c.id%>"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></a>
          <!--<span class="badge">%=c.finish_time.to_time.hour%> : %=c.finish_time.to_time.min%></span></span>-->
          </div>
        
      <%end%>
      
    </div>

<!--<div class="progress" aria-valuemax="86400">-->
<!--  <div class="progress-bar progress-bar-success" style="width: 3600">-->
<!--    <span class="sr-only"><=%=c.finish_time-c.start_time%>% Complete (success)</span>-->
<!--  </div>-->
<!--  <div class="progress-bar progress-bar-warning progress-bar-striped" style="width: 20%">-->
<!--    <span class="sr-only">20% Complete (warning)</span>-->
<!--  </div>-->
<!--  <div class="progress-bar progress-bar-danger" style="width: 10%">-->
<!--    <span class="sr-only">10% Complete (danger)</span>-->
<!--  </div>-->
<!--</div>-->

</div>

</div>
<div class="col-md-3 col-md-offset-1">
  <div class="panel panel-info">
    <div class="panel-heading">
      <h3 class="panel-title"><center>예약 현황을 볼 날짜를 선택해라</center></h3>
    </div>
    <div class="panel-body">
      <center>
      <!--<div class="well">-->
        <form action="/book/view_booking" method="POST">
          <input type="date" name="show_date" required> 
          <input type="hidden" name="id" value="<%=@class.id%>"> 
          <button type="submit"class="btn btn-primary btn-sm">날짜 검색</button>
        </form>
      <!--</div>-->
       </center>
    </div>
  </div>
  
</div>
  
 
<!--  <div class="panel panel-info">-->
    
  <!--  <div class="panel-heading">-->
  <!--    <h3 class="panel-title"><center>예약 타임 테이블 </center></h3>-->
  <!--  </div>-->
    
  <!--  <div class="panel-body">-->
  <!--    <table class="table table-striped table-hover ">-->
  <!--      <thead>-->
  <!--        <tr>-->
  <!--          <th width="15%">시간 \ 요일</th>-->
  <!--          <th id="월">월</th>-->
  <!--          <th id="화">화</th>-->
  <!--          <th id="수">수</th>-->
  <!--          <th id="목">목</th>-->
  <!--          <th id="금">금</th>-->

  <!--        </tr>-->
  <!--      </thead>-->
  <!--      <tbody>-->
  <!--        <tr>-->
  <!--          <td id="1교시">09:00 - 10:00</td>-->
  <!--          <td id="월1"></td>-->
  <!--          <td id="화1"></td>-->
  <!--          <td id="수1"></td>-->
  <!--          <td id="목1"></td>-->
  <!--          <td id="금1"></td>-->
  <!--        </tr>-->
          
  <!--        <tr>-->
  <!--          <td id="2교시">10:00 - 11:00</td>-->
  <!--          <td id="월2"></td>-->
  <!--          <td id="화2"></td>-->
  <!--          <td id="수2"></td>-->
  <!--          <td id="목2"></td>-->
  <!--          <td id="금2"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="3교시">12:00 - 13:00</td>-->
  <!--          <td id="월3"></td>-->
  <!--          <td id="화3"></td>-->
  <!--          <td id="수3"></td>-->
  <!--          <td id="목3"></td>-->
  <!--          <td id="금3"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="4교시">13:00 - 14:00</td>-->
  <!--          <td id="월4"></td>-->
  <!--          <td id="화4"></td>-->
  <!--          <td id="수4"></td>-->
  <!--          <td id="목4"></td>-->
  <!--          <td id="금4"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="5교시">14:00 - 15:00</td>-->
  <!--          <td id="월5"></td>-->
  <!--          <td id="화5"></td>-->
  <!--          <td id="수5"></td>-->
  <!--          <td id="목5"></td>-->
  <!--          <td id="금5"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="6교시">15:00 - 16:00</td>-->
  <!--          <td id="월6"></td>-->
  <!--          <td id="화6"></td>-->
  <!--          <td id="수6"></td>-->
  <!--          <td id="목6"></td>-->
  <!--          <td id="금6"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="7교시">16:00 - 17:00</td>-->
  <!--          <td id="월7"></td>-->
  <!--          <td id="화7"></td>-->
  <!--          <td id="수7"></td>-->
  <!--          <td id="목7"></td>-->
  <!--          <td id="금7"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="8교시">17:00 - 18:00</td>-->
  <!--          <td id="월8"></td>-->
  <!--          <td id="화8"></td>-->
  <!--          <td id="수8"></td>-->
  <!--          <td id="목8"></td>-->
  <!--          <td id="금8"></td>-->
  <!--        </tr>-->
  <!--        <tr>-->
  <!--          <td id="9교시">18:00 - 19:00</td>-->
  <!--          <td id="월9"></td>-->
  <!--          <td id="화9"></td>-->
  <!--          <td id="수9"></td>-->
  <!--          <td id="목9"></td>-->
  <!--          <td id="금9"></td>-->
  <!--        </tr>-->
  <!--      </tbody>-->
  <!--    </table>-->
  <!--  </div>-->
      
  <!--</div>-->
<!--</div>-->


<div class="col-md-7 col-md-offset-0">
  <table class="table table-striped table-hover ">
    <thead>
      <tr class="info">
        <th>#</th>
        <th>사용자 이름</th>
        <th>사용날짜</th>
        <th>사용시간</th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @class.reservations.where(date: @date).order(:start_time).each do |c| %>
          <tr>
            
            <td><%=c.id%></td>
            <td><%=User.find(c.user).student_name %> (<%=User.find(c.user).student_number %>)</td>
            <td><%=c.date%></td>
            <td><%=c.start_time.to_s(:db)%> ~ <%=c.finish_time.to_s(:db)%></td>
            <td><span class="label label-info" id="view_state<%=c.id%>" value="<%=c.state%>"><%=c.state%></span>    <!--현재 진행상태 보여줌--></td>
            
            <td>
              <% if current_user %> <!--로그인 된 상태.-->
                
                <%  if current_user.email == "admin@ptu.ac.kr" %> <!--관리자일때 승인하기-->
                  
                  <% if c.state=="승인대기" %>
                    <!--<input onclick="change(<=c.id%>)" type="button" value="승인하기" id="button<=c.id%>"></input>-->
                    <button type="button" class="btn btn-primary btn-sm" id="button<%=c.id%>" onclick="change(<%=c.id%>)">승인하기</button>
                    
                    
                  <% else %>
                    <!--<input onclick="change(%=c.id%>)" type="button" value="승인취소" id="button%=c.id%>"></input>-->
                    <button type="button" class="btn btn-primary btn-sm" id="button<%=c.id%>" onclick="change(<%=c.id%>)">승인취소</button>
                  <!--<input class="btn btn-primary btn-sm" onclick="change()" value="승인하기" id="<=c.id%>"></input>-->
                    
                  <%end%>
                                
                <% end %>
                                 
              <% end %> <!-- if current_user end -->
                    
<script type="text/javascript">
  
  function change(reservation_id){
        
        var button="button" + reservation_id;
        var view_state="view_state" + reservation_id;
        var re_state=document.getElementById(view_state).innerHTML;
        
        if (re_state == "승인대기")//승인대기라면
          //상태표시 바꾸고 버튼 텍스트도 바꿔줘야한다 db도!
          $.ajax({
            data: {
              reservation_num: reservation_id,
              state: "승인완료"
            },
            url: "/book/update_state",
            success: function(){
              // alert("db 저장 완료");
              document.getElementById(view_state).innerHTML="승인완료";
              document.getElementById(button).innerHTML="승인취소";
            },
            error:function(request,status,error){
            alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
          });
          //db 바꿔줌
        
        else
          $.ajax({
            data: {
              reservation_num: reservation_id,
              state: "승인대기"
            },
            url: "/book/update_state",
            success: function(){
              // alert("db 저장 완료");
              document.getElementById(view_state).innerHTML="승인대기";
              document.getElementById(button).innerHTML="승인하기";
            },
            error:function(request,status,error){
            alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
          });
          
          
  };

</script>
            </td>
               
            <td><button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#show<%=c.id%>">상세보기</button></td>
            
            <td>
            <% if current_user %>
               <% if User.find(c.user).email == current_user.email %>
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#show_check<%=c.id%>" >예약 취소</button>
               <% else %>
                 
               <%end%>
            <% else %>
            
            <% end %>
            </td>
          </tr>

      <% end %>
    </tbody>
  </table> 
</div>
</div> <!--row의 div>


<% @class.reservations.where(date: @date).each do |c| %><!--예약취소 모달-->

<div id="show_check<%=c.id%>" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">예약 취소</h4>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="recipient-name" class="control-label">예약을 취소하시겠습니까?</label>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <form action="/book/delete/<%=c.id%>" method="POST">
              <button type="submit" class="btn btn-primary">취소하기</button>
            </form>
      </div>
      </div>
    </div>
  </div>
</div>


      
          
<div id="show<%=c.id%>" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><!--예약상세보기-->
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel"> 예약 상세 보기</h4>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label for="recipient-name" class="control-label">사용자</label>
          <%=c.user%>
        </div>
        
        
        <div class="form-group">
          <label for="recipient-name" class="control-label">사용시간</label>
          <%=c.start_time.to_s(:db)%> ~ <%=c.finish_time.to_s(:db)%>
        </div>
        
        <div class="form-group">
          <label for="recipient-name" class="control-label">사용목적</label>
          <%=c.purpose%>
        </div>
        
        <div class="form-group">
          <label for="recipient-name" class="control-label">담당 교수</label>
          <%=c.professor%>            
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id = "ok" >승인하기</button>

      </div>
    </div>
  </div>
</div>
<%end%>


</div>
